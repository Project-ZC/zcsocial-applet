<view class="container">
  <!-- 顶部导航栏 -->
  <view class="header">
    <view class="back-btn" bindtap="safeNavigateBack">
      <text class="iconfont icon-back"></text>
    </view>
    <view class="title">团队管理</view>
    <view class="header-right">
      <view class="action-btn gen-qrcode" bindtap="generateQRCode">
        <text class="iconfont icon-qrcode"></text>
      </view>
      <view class="action-btn add-btn" bindtap="openAddModal">
        <text class="iconfont icon-add"></text>
      </view>
    </view>
  </view>



  <!-- 员工管理页 -->
  <view class="staff-container">
    <!-- 角色筛选 -->
    <view class="role-filter">
      <view class="role-item {{currentRole === 'all' ? 'active' : ''}}" 
            bindtap="filterByRole" 
            data-role="all">全部</view>
      <view class="role-item {{currentRole === '店长' ? 'active' : ''}}" 
            bindtap="filterByRole" 
            data-role="店长">店长</view>
      <view class="role-item {{currentRole === '调酒师' ? 'active' : ''}}" 
            bindtap="filterByRole" 
            data-role="调酒师">调酒师</view>
             <view class="role-item {{currentRole === '服务员' ? 'active' : ''}}" 
             bindtap="filterByRole" 
             data-role="服务员">主理人</view>
      <view class="role-item {{currentRole === '其他' ? 'active' : ''}}" 
            bindtap="filterByRole" 
            data-role="其他">其他</view>
    </view>

    <!-- 员工列表 -->
    <view class="staff-list" wx:if="{{!isLoading && filteredStaffList.length > 0}}">
      <view class="staff-item" wx:for="{{filteredStaffList}}" wx:key="id">
        <view class="staff-avatar">
          <image src="{{item.avatar}}" mode="aspectFill"></image>
        </view>
        <view class="staff-info">
          <view class="staff-header">
            <view class="staff-name">{{item.name}}</view>
            <view class="staff-role">{{item.role}}</view>
          </view>
          <view class="staff-intro">{{item.intro}}</view>
                     <view class="staff-contact" wx:if="{{item.phone || item.wechat}}">
             <text wx:if="{{item.phone}}">电话: {{item.phone}}</text>
             <text wx:if="{{item.phone && item.wechat}}"> | </text>
             <text wx:if="{{item.wechat}}">零卡id: {{item.wechat}}</text>
           </view>
          <view class="staff-permissions" wx:if="{{item.permissions && item.permissions.length > 0}}">
            <text class="permission-tag" wx:for="{{item.permissionNames}}" wx:key="*this">{{item}}</text>
          </view>
        </view>
        <view class="staff-actions">
          <view class="action-edit" bindtap="openEditModal" data-id="{{item.id}}">
            <text class="iconfont icon-edit"></text>
          </view>
          <view class="action-delete" bindtap="openDeleteModal" data-id="{{item.id}}">
            <text class="iconfont icon-delete"></text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 员工列表为空状态 -->
    <view class="empty-state" wx:if="{{!isLoading && filteredStaffList.length === 0}}">
      <image src="/static/images/empty-staff.png" mode="aspectFit"></image>
      <view class="empty-text">暂无员工</view>
      <view class="empty-subtext">点击右上角"+"添加员工</view>
    </view>
  </view>



  <!-- 加载状态 -->
  <view class="loading" wx:if="{{isLoading}}">
    <image src="/static/images/loading.gif" mode="aspectFit"></image>
    <text>加载中...</text>
  </view>

  <!-- 添加/编辑员工模态框 -->
  <view class="modal" wx:if="{{showModal}}">
    <view class="modal-mask" bindtap="closeModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{isEdit ? '编辑员工' : '添加员工'}}</text>
        <view class="close-btn" bindtap="closeModal">×</view>
      </view>
      
      <view class="modal-body">
        <!-- 统一搜索栏（仅在添加模式显示） -->
        <view class="unified-search-container" wx:if="{{!isEdit}}">
          <view class="search-tabs">
            <view class="search-tab {{searchType === 'phone' ? 'active' : ''}}" 
                  bindtap="switchSearchType" 
                  data-type="phone">手机号</view>
            <view class="search-tab {{searchType === 'zero' ? 'active' : ''}}" 
                  bindtap="switchSearchType" 
                  data-type="zero">零卡ID</view>
          </view>
          <view class="search-box">
            <input class="search-input" 
                   placeholder="{{searchType === 'phone' ? '请输入手机号码' : '请输入零卡ID'}}" 
                   value="{{searchKeyword}}"
                   type="{{searchType === 'phone' ? 'number' : 'text'}}"
                   bindinput="onSearchInput" />
            <button class="search-btn-modal" bindtap="onSearch">搜索</button>
          </view>
        </view>

                 <view class="form-item">
           <view class="form-label">头像</view>
           <view class="avatar-picker" bindtap="{{isEdit ? '' : 'chooseImage'}}">
             <image 
               class="avatar-image" 
               src="{{tempStaff.avatar || '/static/images/default-avatar.png'}}" 
               mode="aspectFill">
             </image>
             <view class="avatar-upload-icon" wx:if="{{!isEdit}}">
               <text class="iconfont icon-camera"></text>
             </view>
           </view>
         </view>
        
                 <view class="form-item">
           <view class="form-label">姓名</view>
           <input 
             class="form-input" 
             placeholder="请输入员工姓名" 
             value="{{tempStaff.name}}" 
             bindinput="bindStaffName"
             disabled="{{isEdit}}">
           </input>
         </view>
        
                 <view class="form-item">
           <view class="form-label">职位</view>
           <view class="role-display">
             <view class="current-role">{{tempStaff.role || '实习生'}}</view>
             <view class="role-tip">职位将根据所选权限自动生成</view>
           </view>
         </view>
        
                 <view class="form-item">
           <view class="form-label">手机号</view>
           <input 
             class="form-input" 
             type="number" 
             placeholder="请输入手机号码" 
             value="{{tempStaff.phone}}" 
             bindinput="bindStaffPhone"
             disabled="{{isEdit}}">
           </input>
         </view>
        
                 <view class="form-item">
           <view class="form-label">零卡id</view>
           <input 
             class="form-input" 
             placeholder="请输入零卡id" 
             value="{{tempStaff.wechat}}" 
             bindinput="bindStaffWechat"
             disabled="{{isEdit}}">
           </input>
         </view>
        
        <view class="form-item">
          <view class="form-label">员工权限</view>
          <view class="permissions-list">
            <view class="permission-item" 
                  wx:for="{{permissionOptions}}" 
                  wx:key="value"
                  bindtap="togglePermission" 
                  data-permission="{{item.value}}">
              <view class="permission-checkbox {{tempStaff.permissions && tempStaff.permissions.includes(item.value) ? 'checked' : ''}}">
                <text class="iconfont icon-check" wx:if="{{tempStaff.permissions && tempStaff.permissions.includes(item.value)}}"></text>
              </view>
              <view class="permission-content">
                <view class="permission-name">{{item.name}}</view>
                <view class="permission-desc">{{item.description}}</view>
              </view>
            </view>
          </view>
        </view>
        
                 <view class="form-item">
           <view class="form-label">简介</view>
           <textarea 
             class="form-textarea" 
             placeholder="请输入员工简介" 
             value="{{tempStaff.intro}}" 
             bindinput="bindStaffIntro"
             disabled="{{isEdit}}">
           </textarea>
         </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="closeModal">取消</button>
        <button class="confirm-btn" bindtap="saveStaff">保存</button>
      </view>
    </view>
  </view>



  <!-- 删除确认模态框 -->
  <view class="confirm-modal" wx:if="{{showDeleteModal}}">
    <view class="modal-mask" bindtap="closeDeleteModal"></view>
    <view class="confirm-content">
      <view class="confirm-title">确认删除</view>
      <view class="confirm-message">确定要删除该员工吗？此操作不可撤销。</view>
      <view class="confirm-btns">
        <button class="cancel-btn" bindtap="closeDeleteModal">取消</button>
        <button class="delete-btn" bindtap="deleteStaff">删除</button>
      </view>
    </view>
  </view>

  <!-- 店铺二维码模态框 -->
  <view class="modal" wx:if="{{showQRCodeModal}}">
    <view class="modal-mask" bindtap="closeQRCodeModal"></view>
    <view class="qrcode-modal-content">
      <view class="modal-header">
        <text>店铺招募二维码</text>
        <view class="close-btn" bindtap="closeQRCodeModal">×</view>
      </view>
      
      <view class="qrcode-container">
        <image 
          class="qrcode-image" 
          src="{{shopQRCode}}" 
          mode="aspectFit" 
          show-menu-by-longpress>
        </image>
        <view class="qrcode-tip">长按保存或分享该二维码</view>
      </view>
      
      <view class="qrcode-actions">
        <button class="save-btn" bindtap="saveQRCodeToAlbum">保存到相册</button>
        <button class="share-btn" open-type="share">分享给好友</button>
      </view>
    </view>
  </view>
</view> 